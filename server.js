// AI24Solutions Telegram-–±–æ—Ç —Å –∑–∞–ø–∏—Å—å—é –≤ Google Sheets
const express = require('express');
const bodyParser = require('body-parser');
const { Telegraf, Markup } = require('telegraf');
const { google } = require('googleapis');
const path = require('path');
require('dotenv').config();
keyFile: path.join(__dirname, 'credentials.json')

const app = express();
app.use(bodyParser.json());

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);

const auth = new google.auth.GoogleAuth({
  keyFile: path.join(__dirname, 'credentials.json'),
  scopes: ['https://www.googleapis.com/auth/spreadsheets']
});

const SPREADSHEET_ID = '1CajOn3ncsj8h21uxAk10XQWJTD40R6195oJKGSQPJaQ';
const SHEET_NAME = '–õ–∏—Å—Ç2';

const mainMenu = Markup.keyboard([
  ['üí° –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç AI24', 'üìù –ü—Ä–æ–π—Ç–∏ –∫–≤–∏–∑'],
  ['ü§ñ –ó–∞–¥–∞—Ç—å AI-–≤–æ–ø—Ä–æ—Å']
]).resize();

const greetings = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç AI24Solutions ü§ñ\n\n–ü–æ–º–æ–≥–∞—é —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –Ω–µ–π—Ä–æ-—Ä–µ—à–µ–Ω–∏—è–º–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –Ω–∏–∂–µ:`;

const assistantOptions = [
  "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤",
  "–ß–∞—Ç-–±–æ—Ç—ã –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã",
  "–û–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º",
  "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ò–ò-—Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –∑–∞–¥–∞—á—É",
  "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
];

const assistantResponses = {
  "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤": `üìä –ê—É–¥–∏—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:\n\n‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞—É–¥–∏—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ò–ò\n‚Ä¢ SEO-–∞—É–¥–∏—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏\n‚Ä¢ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π digital-–∞—É–¥–∏—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤\n\nüîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://ai24solutions.ru/audits`,

  "–ß–∞—Ç-–±–æ—Ç—ã –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã": `ü§ñ –ß–∞—Ç-–±–æ—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞:\n\n‚Ä¢ –ü—Ä–æ–¥–∞–∂–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, HR, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è\n‚Ä¢ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞\n‚Ä¢ AI-–±–æ—Ç—ã —Å GPT –∏ DialogFlow\n\nüîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://ai24solutions.tilda.ws/chat-bots`,

  "–û–±—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º": `üéì –û–±—É—á–µ–Ω–∏–µ –ò–ò –∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º:\n\n‚Ä¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫—É–º—ã (2‚Äì4 —á–∞—Å–∞)\n‚Ä¢ –ë–µ–∑ –≤–æ–¥—ã: —á—ë—Ç–∫–∏–µ —à–∞–±–ª–æ–Ω—ã –∏ –ø—Ä–æ–º–ø—Ç—ã\n‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –≤–∞—à–∏—Ö –∑–∞–¥–∞—á–∞—Ö –∏ –∫–µ–π—Å–∞—Ö\n\nüîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://ai24solutions.ru/educations`,

  "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ò–ò-—Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –∑–∞–¥–∞—á—É": `üìà AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:\n\n‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤\n‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç –Ω–∞ 30%+\n\nüîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://ai24solutions.ru/analytics`
};

const faq = {
  "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç": "–û–±—ã—á–Ω–æ —Ä–µ—à–µ–Ω–∏—è —Å—Ç–∞—Ä—Ç—É—é—Ç –æ—Ç 15 000‚ÇΩ. –ú—ã –ø–æ–¥–±–∏—Ä–∞–µ–º –ø–æ–¥ –∑–∞–¥–∞—á—É. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç–µ—Å—å ‚Äî —è –ø—Ä–µ–¥–ª–æ–∂—É –ø–æ–¥—Ö–æ–¥—è—â–µ–µ.",
  "–∫—Ç–æ –≤—ã": "AI24Solutions ‚Äî –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ –∏–∑ –ë–µ–ª–∞—Ä—É—Å–∏. –ú—ã —Å–æ–∑–¥–∞—ë–º —á–∞—Ç-–±–æ—Ç–æ–≤, –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤ –∏ –æ–±—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–µ —Å –ò–ò.",
  "—á—Ç–æ –º–æ–∂–µ—Ç–µ": "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ–º –≤–æ—Ä–æ–Ω–∫–∏, –≤–Ω–µ–¥—Ä—è–µ–º AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤, CRM, Telegram-–±–æ—Ç–æ–≤ –∏ –æ–±—É—á–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —Å—Ç–æ–∏—Ç."
};

function handleUserMessage(msg) {
  const lower = msg.toLowerCase();
  for (const key in faq) {
    if (lower.includes(key)) return faq[key];
  }
  return `–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! –Ø –ø–µ—Ä–µ–¥–∞–º –µ–≥–æ –∫–æ–º–∞–Ω–¥–µ. –ê –ø–æ–∫–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ üëá`;
}

const contactForm = `–ß—Ç–æ–±—ã –º—ã –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à –±–∏–∑–Ω–µ—Å, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤:\n\n1Ô∏è‚É£ –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?\n2Ô∏è‚É£ –ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à –±–∏–∑–Ω–µ—Å?\n3Ô∏è‚É£ –ö–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —Å—Ç–æ–∏—Ç?\n4Ô∏è‚É£ –ö–æ–Ω—Ç–∞–∫—Ç (Telegram / –ø–æ—á—Ç–∞)`;

function formatLead(data) {
  return `üì• –ù–æ–≤—ã–π –ª–∏–¥:\nüë§ –ò–º—è: ${data.name}\nüè¢ –ë–∏–∑–Ω–µ—Å: ${data.business}\nüéØ –ó–∞–¥–∞—á–∞: ${data.goal}\nüì¨ –ö–æ–Ω—Ç–∞–∫—Ç: ${data.contact}`;
}

let formStep = {};
let formData = {};
const awaitingAIQuestion = new Set();

bot.start((ctx) => {
  const userName = ctx.from.first_name || '–¥—Ä—É–≥';
  ctx.reply(`–ü—Ä–∏–≤–µ—Ç, ${userName}!

${greetings}`, mainMenu);
});

bot.hears('üí° –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç AI24', (ctx) => {
  ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ:', Markup.keyboard(assistantOptions.map(o => [o])).resize());
});

bot.hears('üìù –ü—Ä–æ–π—Ç–∏ –∫–≤–∏–∑', (ctx) => {
  ctx.reply('–û—Ç–∫—Ä–æ–π—Ç–µ –∫–≤–∏–∑ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ:', {
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: 'üöÄ –ü—Ä–æ–π—Ç–∏ –∫–≤–∏–∑',
            web_app: { url: process.env.WEB_APP_URL }
          }
        ]
      ]
    }
  });
});

bot.hears('ü§ñ –ó–∞–¥–∞—Ç—å AI-–≤–æ–ø—Ä–æ—Å', (ctx) => {
  awaitingAIQuestion.add(ctx.from.id);
  ctx.reply('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ AI ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å üôÇ');
});

bot.on('text', async (ctx) => {
  const id = ctx.from.id;
  const text = ctx.message.text;

  if (awaitingAIQuestion.has(id)) {
    awaitingAIQuestion.delete(id);
    return ctx.reply('üß† (–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç OpenAI –∏–ª–∏ –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏ ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ).');
  }

  if (formStep[id]) {
    const step = formStep[id];
    if (!formData[id]) formData[id] = {};
    if (step === 1) formData[id].name = text;
    if (step === 2) formData[id].business = text;
    if (step === 3) formData[id].goal = text;
    if (step === 4) {
      formData[id].contact = text;
      const msg = formatLead(formData[id]);
      await ctx.reply("‚úÖ –°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.");
      await bot.telegram.sendMessage(process.env.ADMIN_ID, msg);
      formStep[id] = 0;
      formData[id] = null;
      return;
    }
    formStep[id]++;
    if (formStep[id] === 2) ctx.reply("2Ô∏è‚É£ –ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à –±–∏–∑–Ω–µ—Å?");
    if (formStep[id] === 3) ctx.reply("3Ô∏è‚É£ –ö–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —Å—Ç–æ–∏—Ç?");
    if (formStep[id] === 4) ctx.reply("4Ô∏è‚É£ –ö–æ–Ω—Ç–∞–∫—Ç (Telegram / –ø–æ—á—Ç–∞)");
    return;
  }

  if (text === assistantOptions[4]) {
    formStep[id] = 1;
    ctx.reply("1Ô∏è‚É£ –ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?");
    return;
  }

  if (assistantResponses[text]) {
    return ctx.reply(assistantResponses[text]);
  }

  const answer = handleUserMessage(text);
  ctx.reply(answer);
});

app.post('/send-results', async (req, res) => {
  const { name, email, answers } = req.body;
  const message = `üì• –ù–æ–≤—ã–π –∫–≤–∏–∑:\nüë§ –ò–º—è: ${name}\nüí¨ Telegram: ${email}\nüß† –û—Ç–≤–µ—Ç—ã:\n${answers.join('\n')}`;

  try {
    await bot.telegram.sendMessage(process.env.ADMIN_ID, message);

    const authClient = await auth.getClient();
    const sheets = google.sheets({ version: 'v4', auth: authClient });
    const now = new Date().toLocaleString('ru-RU');

    await sheets.spreadsheets.values.append({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SHEET_NAME}!A1`,
      valueInputOption: 'USER_ENTERED',
      requestBody: {
        values: [[now, name, email, ...answers]]
      }
    });

    res.status(200).send('OK');
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram –∏–ª–∏ Google Sheets:', err);
    res.status(500).send('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
  }
});

app.get('/', (_, res) => {
  res.send('AI24Solutions bot is live ‚úÖ');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç ${PORT}`);
});

bot.launch();
console.log('‚úÖ AI24Solutions –±–æ—Ç –∑–∞–ø—É—â–µ–Ω');
